<?php

/**
 * Implementation of hook_element_info()
 */
function tweetbutton_element_info() {
  module_load_include('inc', 'tweetbutton', 'tweetbutton.elements');
  return _tweetbutton_element_info();
}

/**
 * Implementation of hook_field_info() 
 */
function tweetbutton_field_info() {
  return array(
    'tweetbutton' => array(
      'label' => 'Tweetbutton',
      'description' => 'Creates a tweetbutton field',
      'instance_settings' => array( 'tweet_text', 'author_twitter'),
      'default_widget' => 'tweetbutton',
      'default_formatter' => 'tweetbutton_formatter_button_horizontal',
    ),
  );
}

/**
 * Implementation of hook_field_is_empty() 
 */
function tweetbutton_field_is_empty($item, $field) {
  return FALSE;
}

/**
 * Implementation of hook_field_settings_form 
 */
function tweetbutton_field_settings_form($field, $instance, $has_data) {
  $settings = $field['settings'];
  
  $form = array();
  
  $form['tweet_text'] = array(
    '#type' => 'textfield',
    '#title' =>  t('Tweet text'),
    '#default_value' => isset($settings['tweet_text'])? $settings['tweet_text']: variable_get('tweetbutton_tweet_text'),
  );


  $form['author_twitter'] = array(
    '#type' => 'textfield',
    '#title' => t('Author twitter account'),
    '#default_value' => isset($settings['author_twitter'])? $settings['author_twitter']: variable_get('tweetbutton_account'),
    '#description' => t('This user will be @mentioned in the suggested'),
  );
  
  $form['tokens'] = array(
    '#token_types' => array($instance['entity_type']),
    '#theme' => 'token_tree',
  );
  
  return $form;
}

/**
 * Implementation of hook_field_widget_info() 
 */
function tweetbutton_field_widget_info() {
  return array(
    'tweetbutton' => array(
      'label' => t('Tweetbutton'),
      'field types' => array('tweetbutton'),
      'behaviors' => array(
        'multiple values' => FIELD_BEHAVIOR_DEFAULT,
        'default value' => FIELD_BEHAVIOR_DEFAULT
      ),
    ),
  );
}

/**
 * Implementation of hook_field_widget_form() 
 */
function tweetbutton_field_widget_form(&$form, &$form_state, $field, $instance, $langcode, $items, $delta, $element) {
  $element['text'] = array(
    '#type' => 'textfield',
    '#default_value' => isset($field['settings']['author_twitter'])? $field['settings']['author_twitter']: '',
    '#title' => t('Author twitter account'),
    '#description' => t('Leave blank to use global twitter account.'),
    '#maxlength' => 128,
    '#access' => user_access('use tweetbutton field'),
  );
  
  $element['account'] = array(
    '#type' => 'textfield',
    '#default_value' => isset($field['settings']['tweet_text'])? $field['settings']['tweet_text']: '',
    '#title' => t('Tweet text'),
    '#description' => t('Leave blank to use page title as tweet text'),
    '#maxlength' => 32,
    '#access' => user_access('use tweetbutton field'),
  );
  
  return $element;
}

/**
 * Implementation of hook_field_presave() 
 */
function tweetbutton_field_presave($entity_type, $entity, $field, $instance, $langcode, &$items) {
  if ($field['type'] == 'tweetbutton') {
    foreach ($items as $delta => $item) {
      $data = array($entity_type => $entity);
      $items[$delta]['text'] = !empty($items[$delta]['text'])? token_replace($items[$delta]['text'], $data): '';
      $items[$delta]['account'] = !empty($items[$delta]['account'])? token_replace($items[$delta]['account'], $data): '';
    }
  }
}

/**
 * Implementation of hook_field_formatter_info()
 */
function tweetbutton_field_formatter_info() {
  return array(
    'tweetbutton_formatter_button_vertical' => array(
      'label' => t('Tweetbutton style vertical'),
      'field_types' => array('tweetbutton'),
    ),
    'tweetbutton_formatter_button_horizontal' => array(
      'label' => t('Tweetbutton style horizontal'),
      'field_types' => array('tweetbutton'),
    ),
    'tweetbutton_formatter_button_none' => array(
      'label' => t('Tweetbutton style none'),
      'field_types' => array('tweetbutton'),
    ),
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function tweetbutton_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  
  $delta = 0;
  switch ($display['type']) {
    case 'tweetbutton_formatter_button_vertical':
      $button_type = 'vertical';
      break;
    case 'tweetbutton_formatter_button_horizontal':
      $button_type = 'horizontal';
      break;
    case 'tweetbutton_formatter_button_none':
      $button_type = 'none';
      break;
  }

  $element[$delta] = array(
      '#theme' => 'tweetbutton_display',
      '#options' => array(
        'type' => $button_type,
       ),
       '#tweet_text' => $items[$delta]['text'],
    );
}

/**
 * Implementation of hook_help()
 */
function tweetbutton_help($path, $arg) {
	$output = NULL;
  switch($path) {
  	case 'admin/help#tweetbutton':
      $output = 'This button allows your website to let people share content on Twitter without having to leave the page. Promote strategic Twitter accounts at the same time while driving traffic to your website.';
      break;
    case 'admin/config/services/tweetbutton':
      $output = '<p>' . t('This button allows your website to let people share content on Twitter without having to leave the page. Promote strategic Twitter accounts at the same time while driving traffic to your website. These are the general configuration options for the button. Make sure to check the Node Settings to set where the button will appear.') . '</p>';
      break;
    case 'admin/config/services/tweetbutton/node':
      $output = '<p>' . t('Select the node types and location on which the Tweet Button will appear.') . '</p>';
      break;
  }
  return $output;
}

/**
 * Implementation of hook_menu()
 */ 
function tweetbutton_menu() {
	$items = array();

  $items['admin/config/services/tweetbutton'] = array(
    'title'            => 'Tweet Button',
    'description'      => 'Configure the look and behavior of the Tweet Button appears on the site.',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('tweetbutton_admin_settings'),
    'access arguments' => array('administer tweetbutton'),
    'file'             => 'tweetbutton.admin.inc',
    'type'             => MENU_NORMAL_ITEM,
  );

  $items['admin/config/services/tweetbutton/settings'] = array(
    'title'            => 'General Settings',
    'description'      => 'Change the look and behavior of the Tweet Button.',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('tweetbutton_admin_settings'),
    'access arguments' => array('administer tweetbutton'),
    'file'             => 'tweetbutton.admin.inc',
    'weight'           => 0,
    'type'             => MENU_DEFAULT_LOCAL_TASK,
  );

  $items['admin/config/services/tweetbutton/node'] = array(
    'title'            => 'Node Settings',
    'description'      => 'Configure how the Tweet Button interacts with nodes.',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('tweetbutton_node_settings'),
    'access arguments' => array('administer tweetbutton'),
    'file'             => 'tweetbutton.admin.inc',
    'weight'           => 1,
    'type'             => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Implementation of hook_theme()
 */
function tweetbutton_theme() {
	return array(
    'tweetbutton_display' => array(
      'variables' => array('object' => NULL, 'options' => array()),
    ),
  );
}

/**
 * Implementation of hook_permission()
 */
function tweetbutton_permission() {
  return array(
    'administer tweetbutton' => array(
      'title' => t('Administer Tweet Button'),
    ),
    'access tweetbutton' => array(
      'title' => t('Access Tweet Button'),
    ),
    'use tweetbutton field' => array(
      'title' => t('Use tweetbutton field to alter tweet text')
    ),
  );
}

/**
 * Implementation of hook_node_view()
 */
function tweetbutton_node_view($node, $view_mode) {
  if (in_array($node->type, variable_get('tweetbutton_node_types', array('article')), TRUE) 
    && user_access('access tweetbutton')) {
    if (in_array($view_mode, variable_get('tweetbutton_node_location', array('full')), TRUE)) {
  	  $node->content['tweetbutton'] = array(
	      '#object'   => $node,
        '#weight'   => variable_get('tweetbutton_node_weight', -5),
        '#theme'    => 'tweetbutton_display__' . $node->type,
      );
    }
    
    if (in_array('links', variable_get('tweetbutton_node_location', array('full')), TRUE)) {  
      $node->content['links']['#links']['node_tweetbutton_link'] = array(
        'title' => theme('tweetbutton_display__' . $node->type, array('object' => $node, 'options' => array('type' => 'horizontal'))), 
        'html' => TRUE,
      );
    }
  }
}

/**
 * Implementation of hook_block_info()
 */
function tweetbutton_block_info() {
  $blocks['tweetbutton'] = array(
    'info' => t('Tweetbutton'),
    'weight' => 0,    
  );  
  
  return $blocks;
}

/**
 * Implementation of hook_block_configure 
 */
function tweetbutton_block_view($delta = '') {
  if ($delta == 'tweetbutton') {
    $block['subject'] = t('Tweetbutton');
    $block['content'] = theme('tweetbutton_display', array('options' => array('text' => '')));
    return $block; 
  }
}

/**
 * Helper function to build the required tweet attributes
 * @param $object
 *   Entity object can either be (node, user, taxonomy) 
 * @param $options
 *   Context specific options
 * @return 
 *   List of attributes to be rendered for twitter tweetbutton
 */
function tweetbutton_get_attributes($object = NULL, $options = array()) {
  global $language;
  $entity_type = empty($options['entity_type'])? 'node': $options['entity_type']; 
  
  $default_option = array(
    'type'        => variable_get('tweetbutton_button', 'vertical'),
    'text'        => variable_get('tweetbutton_tweet_text'),
    'language'    => variable_get('tweetbutton_language'),
    'account'     => variable_get('tweetbutton_account'),
    'rel_account' => variable_get('tweetbutton_rel_account_name'),
    'rel_desc'    => variable_get('tweetbutton_rel_account_description'),
  );
  
  if (empty($options['url'])) {
    if (empty($object)) {
      $options['url'] = url($_GET['q'], array('absolute' => TRUE));  
    }
    else {
      $uri = entity_uri($entity_type, $object);
      $options['url'] = url($uri['path'], array('absolute' => TRUE)); 
    }
  }

  $options += $default_option;
  
  $attributes =  array(
    'data-count'   => $options['type'],
    'data-via'     => $options['account'],
    'data-related' => $options['rel_account'] . ':' . $options['rel_desc'],
    'data-text'    => !empty($options['text'])? token_replace($options['text'], array($entity_type => $object)): '',
    'data-counturl'=> $options['url'],
    'data-url'     => $options['url'],
    'data-lang'    => $options['language'] == 'auto' ? $language->language : $options['language'],
    'class'        => 'twitter-share-button',
  );

  return $attributes;
}


function theme_tweetbutton_display($variables) {
  $script_url = url('http://platform.twitter.com/widgets.js', array('external' => TRUE));
  drupal_add_js($script_url, array('type' => 'external', 'scope' => 'footer'));
  
  $object = $variables['object'];
  $options = $variables['options'];
  $attributes = tweetbutton_get_attributes($object, $options);
 
  $tweet_link = l(t('Tweet'), 'http://twitter.com/share', array('attributes' => $attributes, 'external' => TRUE));
  $link = '<div class="tweetbutton">' . $tweet_link . '</div>';

  return $link;
}