<?php
// $Id$

/**
 * Implementation of hook_help()
 */
function tweetbutton_help($path, $arg) {
	$output = NULL;
  switch($path) {
  	case 'admin/help#tweetbutton':
      $output = 'This button allows your website to let people share content on Twitter without having to leave the page. Promote strategic Twitter accounts at the same time while driving traffic to your website.';
  }
}

/**
 * Implementation of hook_menu()
 */ 
function tweetbutton_menu() {
	$items = array();
  
  $items['admin/config/tweetbutton'] = array(
    'title'            => 'Tweet Button',
    'description'      => 'Tweet Button Settings',
    'page callback'    => 'system_admin_menu_block_page',
    'access arguments' => array('administer tweetbutton'),
    'file'             => 'system.admin.inc',
    'file path'        => drupal_get_path('module', 'system'),
    'position'         => 'right',
  );
  
  $items['admin/config/tweetbutton/settings'] = array(
    'title'            => 'Tweet Button Settings',
    'description'      => 'Configure tweet button settings',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('tweetbutton_admin_settings'),
    'access arguments' => array('administer tweetbutton'),
    'file'             => 'tweetbutton.admin.inc',
    'weight'           => 0,
  );
  
  $items['admin/config/tweetbutton/node'] = array(
    'title'            => 'Tweet Button Node Settings',
    'description'      => 'Configure tweet button for nodes',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('tweetbutton_node_settings'),
    'access arguments' => array('administer tweetbutton'),
    'file'             => 'tweetbutton.admin.inc',
    'weight'           => 1,
  );
  
  return $items;
}

/**
 * Implementation of hook_theme()
 */
function tweetbutton_theme() {
	return array(
    'tweetbutton_display' => array(
      'variables' => array('style' => NULL),
    ),
  );
}

/**
 * Implementation of hook_permission()
 */
function tweetbutton_permission() {
  return array(
    'administer tweetbutton' => array(
      'title' => t('Administer Tweetbutton'),
    ),
    'access tweetbutton' => array(
      'title' => t('Access tweetbutton'),
    ),
  );
}

/**
 * Implementation of hook_node_view()
 */
function tweetbutton_node_view($node, $view_mode) {
  if (in_array($node->type, variable_get('tweetbutton_node_types', array('article')))) {

   drupal_add_js('http://platform.twitter.com/widgets.js'); 

	 $node->content['tweetbutton'] = array(
      '#markup' => theme('tweetbutton_display'),
      '#weight' => variable_get('tweetbutton_node_weight', 0),
    );
  }
}


function tweetbutton_get_attributes() {
	$button_type = variable_get('tweetbutton_button', 'vertical');
  $tweet_text  = variable_get('tweetbutton_tweet_text');
  $tweet_url   = variable_get('tweetbutton_tweet_url');
  $language    = variable_get('tweetbutton_language');
  $account     = variable_get('tweetbutton_account');
  $rel_account = variable_get('tweetbutton_rel_account_name');
  $rel_desc    = variable_get('tweetbutton_rel_account_description');
  
  $attributes =  array(
    'data-count'   => $button_type,
    'data-via'     => $account,
    'data-related' => "$rel_account:$rel_desc",
    'data-text'    => $tweet_text,
    'data-url'     => $tweet_url,
    'data-lang'    => $language,
  );
  return $attributes;
}

function theme_tweetbutton_display() {
  
  $attributes = tweetbutton_get_attributes();
  
  $link = '<a href="http://twitter.com/share" class="twitter-share-button" ' .
    drupal_attributes($attributes). '>Tweet</a>';
  return $link;
}